<!DOCTYPE html>
<html lang="en">
  <head>
    <title>輿情分析平台</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  </head>

  <body>
    <div class="container">
      <div class="row">
        {% include 'navbar.html' %}
        <div class="col-lg-12">
          <h1>你關心的關鍵詞的情緒分析</h1>
          <p>可以了解媒體對該關鍵詞的情緒程度</p>
        </div>
        <div class="col-lg-6 mb-2">
          <!-- 輸入條件區塊開始 -->
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">輸入條件</h3>
            </div>
            <div class="card-body">
              <div class="form-group row">
                <label class="col-md-3 form-control-label"
                  >關心哪個關鍵詞?</label
                >
                <div class="col-md-9">
                  <input
                    id="input_keyword"
                    name="userkey"
                    value="馬斯克"
                    class="form-control form-control-success"
                  />
                  <small class="form-text text-muted"
                    >查找的關鍵字(或片段文字)，可輸入多個，空白隔開。
                  </small>
                </div>
              </div>

              <div class="row">
                <label class="col-sm-3 form-control-label">條件</label>

                <div class="col-md-9 radio mb-3">
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="and"
                      name="condradio"
                      checked
                    />and</label
                  >
                  <label class="radio-inline"
                    ><input type="radio" value="or" name="condradio" />or</label
                  >
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 form-control-label">新聞類別</label>
                <div class="col-md-9">
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="全部"
                      name="cateradio"
                      checked
                    />全部</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="台股"
                      name="cateradio"
                    />台股</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="國際股"
                      name="cateradio"
                    />國際股</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="陸港股"
                      name="cateradio"
                    />陸港股</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="區塊鏈"
                      name="cateradio"
                    />區塊鏈</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="外匯"
                      name="cateradio"
                    />外匯</label
                  >
                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="期貨"
                      name="cateradio"
                    />期貨</label
                  >

                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-3 form-control-label">最近多少周?</label>
                <div class="col-md-9">

                  <label class="radio-inline"
                    ><input
                      type="radio"
                      value="1"
                      name="wkradio"
                      checked
                    />1</label
                  >

                  <small class="form-text text-muted"
                    >以最新資料時間為準，往前推多少周?</small
                  >
                </div>
              </div>
              <div class="form-group row">
                <div class="col-md-9 ml-auto">
                  <button type="button" id="btn_ok" class="btn btn-primary">
                    查詢
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 輸入區塊結束-->

        <!-- 顯示區塊-->
        <div class="col-lg-6 mb-5">
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">情緒分析:文章層級</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <canvas id="article_senti_pie_chart"></canvas>
              </div>
              <div>
                <ul id="senti_info"></ul>
              </div>
            </div>
          </div>
        </div>
        <!-- 區塊結束-->

        <!-- 顯示區塊-->
        <div class="col-lg-6 mb-5">
          <div class="card">
            <div class="card-header">
              <h3 class="h6 text-uppercase mb-0">正反面情緒變化</h3>
            </div>
            <div class="card-body">
              <small
                >每個時間點的正反面報導的篇數(每天統計，6周含以上以5天為單位統計)</small
              >
              <div class="row">
                <canvas id="time_line_chart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <!-- 區塊結束-->
      </div>
    </div>
  </body>
</html>
<!-- java scrip通常寫在網頁最後面，等頁面初始化之後才會執行-->
<!-- jQuery指令用到的js-->
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<!-- chartjs圖js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<!-- 程式碼區 -->
<script>
  call_ajax();

  //**按鈕事件
  $("#btn_ok").on("click", function () {
    call_ajax();
  }); //event function

  $("input[name='cateradio']").on("change", function () {
    call_ajax();
  }); //event function

  $("input[name='wkradio']").on("change", function () {
    call_ajax();
  }); //event function

  $("input[name='condradio']").on("change", function () {
    call_ajax();
  }); //event function

  // Draw the sentiment line chart here!
  let linechartElem = document
    .getElementById("time_line_chart")
    .getContext("2d");
  //let linechart = null;

  // pie chart
  let piechartElem = document
    .getElementById("article_senti_pie_chart")
    .getContext("2d");

  // Ajax function to draw charts
  function call_ajax() {
    const userkey = $("#input_keyword").val();
    const weeks = $("input[name='wkradio']:checked").val();
    const cate = $("input[name='cateradio']:checked").val();
    const cond = $("input[name='condradio']:checked").val();

    if (userkey.length < 2) {
      alert("輸入關鍵字不可空白或小於兩個中文字!");
      return 0;
    }

    $.ajax({
      type: "POST",
      url: "api_get_userkey_sentiment/",
      //url: "127.0.0.1:8000/key_senti/api_get_userkey_sentiment/",
      data: {
        userkey: userkey,
        cate: cate,
        weeks: weeks,
        cond: cond,
      }, // pass to server
      success: function (received) {
        // draw pie chart
        const data_pie = received["sentiCount"];
        // 先清除前一個圖形
        if (window.piechart) piechart.destroy();
        // 畫圓餅圖函數寫法，前面不要加修飾語const, let, var
        piechart = drawPieChart(piechartElem, data_pie);

        $("#senti_info").empty();
        for (let k in data_pie) {
          $("#senti_info").append(k + ": " + data_pie[k] + "篇 ");
        }
        //$("#senti_info").append("Pos:" + data_pie.pos + "篇, ");
        //$("#senti_info").append("Obj:" + data_pie.obj + "篇, ");
        //$("#senti_info").append("Neg:" + data_pie.neg + "篇");

        // draw time-based line chart
        const data_pos = received["data_pos"];
        const data_neg = received["data_neg"];

        // 先清除前一個圖形
        if (window.linechart) linechart.destroy();
        // 畫線圖
        linechart = drawLineChart(linechartElem, data_pos, data_neg);
      }, //success function
    }); //ajax
  } //function call_ajax()

  // PieChart function寫法
  function drawPieChart(chartElem, chartdata) {
    let chartSpec = {
      type: "pie",
      data: {
        labels: ["正面", "負面", "中立"],
        datasets: [
          {
            data: [chartdata.Positive, chartdata.Negative, chartdata.Neutral],
            backgroundColor: ["rgba(0,0,255,0.3)", "rgba(255,0,0,0.3)", "rgba(150,150,150,0.3)"],
          },
        ],
      },
      options: {},
    };
    return new Chart(chartElem, chartSpec);
  }

  // Line chart function
  function drawLineChart(linechartElem, data_pos, data_neg) {
    // for positive sentiment line chart
    let dataPos = {
      label: "正面",
      data: data_pos,
      borderColor: "rgba(0,0,255,0.3)", //"blue", //藍色表示正面
      backgroundColor: "rgba(0,0,255,0.2)", //背景顏色
      borderWidth: 1,
      fill: true,

    };
    // for negative sentiment line chart
    let dataNeg = {
      label: "負面",
      data: data_neg,
      borderColor:"rgba(255,0,0,0.3)",//"red", //紅色表示負面
      backgroundColor: "rgba(255,0,0,0.2)", //背景顏色
      borderWidth: 1,
      fill: true,
    };

    let options_detail = {
      legend: {
        display: true,
      },
      scales: {
        xAxes: [
          {
            type: "time",
            time: {
              unit: "day",
              displayFormats: {
                //day: 'DD-MM-YYYY'
                day: "MM/DD",
              },
            },
          },
        ],
        yAxes: [
          {
            ticks: {
              beginAtZero: true,
            },
            display: true,
            scaleLabel: {
              display: true,
              labelString: "篇數",
            },
          },
        ],
      },
    };

    let chart_spec = {
      type: "line",
      data: {
        datasets: [dataPos, dataNeg], //有兩條線，兩組資料使用陣列存放即可
      },
      options: options_detail,
    };

    // now draw the sentiment line chart
    //if (linechart)
    //    linechart.destroy();
    return new Chart(linechartElem, chart_spec);
  }

</script>
